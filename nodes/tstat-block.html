<script type="text/html" data-template-name="tstat-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-algorithm" title="Algorithm: single setpoint with diff, split setpoints, or specified setpoints"><i class="fa fa-cog"></i> Algorithm</label>
        <select id="node-input-algorithm">
            <option value="single">Single Setpoint</option>
            <option value="split">Split Setpoint</option>
            <option value="specified">Specified Setpoint</option>
        </select>
    </div>
    <div class="form-row single-setpoint">
        <label for="node-input-setpoint" title="Target temperature setpoint (number from num, msg, flow, or global)"><i class="fa fa-crosshairs"></i> Setpoint</label>
        <input type="text" id="node-input-setpoint" class="node-input-typed" placeholder="70">
        <input type="hidden" id="node-input-setpointType">
    </div>
    <div class="form-row split-setpoint" style="display: none;">
        <label for="node-input-heatingSetpoint" title="Target temperature for heating (number from num, msg, flow, or global)"><i class="fa fa-crosshairs"></i> Heating Setpoint</label>
        <input type="text" id="node-input-heatingSetpoint" class="node-input-typed" placeholder="68">
        <input type="hidden" id="node-input-heatingSetpointType">
    </div>
    <div class="form-row split-setpoint" style="display: none;">
        <label for="node-input-coolingSetpoint" title="Target temperature for cooling (number from num, msg, flow, or global)"><i class="fa fa-crosshairs"></i> Cooling Setpoint</label>
        <input type="text" id="node-input-coolingSetpoint" class="node-input-typed" placeholder="74">
        <input type="hidden" id="node-input-coolingSetpointType">
    </div>
    <div class="form-row split-setpoint" style="display: none;">
        <div id="split-setpoint-warning" style="color: red; display: none; margin-top: 5px;">
            Cooling setpoint must be greater than heating setpoint
        </div>
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-coolingOn" title="Temperature to turn cooling on (number from num, msg, flow, or global)"><i class="fa fa-snowflake-o"></i> Cooling On</label>
        <input type="text" id="node-input-coolingOn" class="node-input-typed" placeholder="74">
        <input type="hidden" id="node-input-coolingOnType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-coolingOff" title="Temperature to turn cooling off (number from num, msg, flow, or global)"><i class="fa fa-snowflake-o"></i> Cooling Off</label>
        <input type="text" id="node-input-coolingOff" class="node-input-typed" placeholder="72">
        <input type="hidden" id="node-input-coolingOffType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-heatingOff" title="Temperature to turn heating off (number from num, msg, flow, or global)"><i class="fa fa-fire"></i> Heating Off</label>
        <input type="text" id="node-input-heatingOff" class="node-input-typed" placeholder="68">
        <input type="hidden" id="node-input-heatingOffType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-heatingOn" title="Temperature to turn heating on (number from num, msg, flow, or global)"><i class="fa fa-fire"></i> Heating On</label>
        <input type="text" id="node-input-heatingOn" class="node-input-typed" placeholder="66">
        <input type="hidden" id="node-input-heatingOnType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <div id="specified-setpoint-warning" style="color: red; display: none; margin-top: 5px;">
            Cooling setpoints must be greater than or equal to heating setpoints (coolingOn >= coolingOff >= heatingOff >= heatingOn)
        </div>
    </div>
    <div class="form-row single-setpoint">
        <label for="node-input-diff" title="Differential for hysteresis (positive number, used in single algorithm)"><i class="fa fa-arrows-v"></i> Differential</label>
        <input type="number" id="node-input-diff" placeholder="2" min="0.01" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-anticipator" title="Temperature offset to stop heating/cooling early (non-negative number)"><i class="fa fa-tachometer"></i> Anticipator</label>
        <input type="text" id="node-input-anticipator" placeholder="0.5">
    </div>
    <div class="form-row">
        <label for="node-input-isHeating" title="Heating mode (true) or cooling mode (false)"><i class="fa fa-fire"></i> Heating Mode</label>
        <input type="checkbox" id="node-input-isHeating" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Effective Setpoints</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Effective Setpoints: Initializing</pre>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("tstat-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            algorithm: { value: "single" },
            setpoint: { value: "70" },
            setpointType: { value: "num" },
            heatingSetpoint: { value: "68" },
            heatingSetpointType: { value: "num" },
            coolingSetpoint: { value: "74" },
            coolingSetpointType: { value: "num" },
            coolingOn: { value: "74" },
            coolingOnType: { value: "num" },
            coolingOff: { value: "72" },
            coolingOffType: { value: "num" },
            heatingOff: { value: "68" },
            heatingOffType: { value: "num" },
            heatingOn: { value: "66" },
            heatingOnType: { value: "num" },
            diff: { value: "2" },
            anticipator: { value: "0.5" },
            isHeating: { value: false }
        },
        inputs: 1,
        outputs: 3,
        outputLabels: ["isHeating", "above", "below"],
        inputLabels: ["input"],
        icon: "font-awesome/fa-thermometer-half",
        paletteLabel: "tstat",
        label: function() {
            return this.name || "tstat";
        },
        oneditprepare: function() {
            const node = this;
            const $algorithm = $("#node-input-algorithm");
            const $singleFields = $(".single-setpoint");
            const $splitFields = $(".split-setpoint");
            const $specifiedFields = $(".specified-setpoint");

            try {
                // Initialize inputs
                $("#node-input-name").val(node.name || "");
                $("#node-input-algorithm").val(node.algorithm || "single");
                $("#node-input-diff").val(node.diff || "2");
                $("#node-input-anticipator").val(node.anticipator || "0.5");
                $("#node-input-isHeating").prop("checked", node.isHeating === true);

                // Initialize typedInput for setpoint
                $("#node-input-setpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-setpointType"
                }).typedInput("type", node.setpointType || "num").typedInput("value", node.setpoint || "70");

                $("#node-input-heatingSetpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-heatingSetpointType"
                }).typedInput("type", node.heatingSetpointType || "num").typedInput("value", node.heatingSetpoint || "68");

                $("#node-input-coolingSetpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-coolingSetpointType"
                }).typedInput("type", node.coolingSetpointType || "num").typedInput("value", node.coolingSetpoint || "74");

                $("#node-input-coolingOn").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-coolingOnType"
                }).typedInput("type", node.coolingOnType || "num").typedInput("value", node.coolingOn || "74");

                $("#node-input-coolingOff").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-coolingOffType"
                }).typedInput("type", node.coolingOffType || "num").typedInput("value", node.coolingOff || "72");

                $("#node-input-heatingOff").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-heatingOffType"
                }).typedInput("type", node.heatingOffType || "num").typedInput("value", node.heatingOff || "68");

                $("#node-input-heatingOn").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-heatingOnType"
                }).typedInput("type", node.heatingOnType || "num").typedInput("value", node.heatingOn || "66");

                // Toggle fields based on algorithm
                function toggleFields() {
                    const algorithm = $algorithm.val();
                    if (algorithm === "single") {
                        $singleFields.show();
                        $splitFields.hide();
                        $specifiedFields.hide();
                        $("#split-setpoint-warning").hide();
                        $("#specified-setpoint-warning").hide();
                        $("#node-input-heatingSetpoint").removeClass("input-error");
                        $("#node-input-coolingSetpoint").removeClass("input-error");
                        $("#node-input-coolingOn").removeClass("input-error");
                        $("#node-input-coolingOff").removeClass("input-error");
                        $("#node-input-heatingOff").removeClass("input-error");
                        $("#node-input-heatingOn").removeClass("input-error");
                    } else if (algorithm === "split") {
                        $singleFields.hide();
                        $splitFields.show();
                        $specifiedFields.hide();
                        $("#specified-setpoint-warning").hide();
                        $("#node-input-coolingOn").removeClass("input-error");
                        $("#node-input-coolingOff").removeClass("input-error");
                        $("#node-input-heatingOff").removeClass("input-error");
                        $("#node-input-heatingOn").removeClass("input-error");
                        validateSplitSetpoints();
                    } else {
                        $singleFields.hide();
                        $splitFields.hide();
                        $specifiedFields.show();
                        $("#split-setpoint-warning").hide();
                        $("#node-input-heatingSetpoint").removeClass("input-error");
                        $("#node-input-coolingSetpoint").removeClass("input-error");
                        validateSpecifiedSetpoints();
                    }
                }

                $algorithm.on("change", toggleFields);
                toggleFields();

                // Validate non-typedInput fields
                $("#node-input-diff").on("input", function() {
                    const val = parseFloat($(this).val());
                    $(this).toggleClass("input-error", isNaN(val) || val <= 0);
                });

                $("#node-input-anticipator").on("input", function() {
                    const val = parseFloat($(this).val());
                    $(this).toggleClass("input-error", isNaN(val) || val < 0);
                });

                // Validate split setpoints
                function validateSplitSetpoints() {
                    if ($algorithm.val() !== "split") {
                        $("#split-setpoint-warning").hide();
                        $("#node-input-heatingSetpoint").removeClass("input-error");
                        $("#node-input-coolingSetpoint").removeClass("input-error");
                        return;
                    }
                    const heatingSetpoint = parseFloat($("#node-input-heatingSetpoint").typedInput("value"));
                    const coolingSetpoint = parseFloat($("#node-input-coolingSetpoint").typedInput("value"));
                    const isInvalid = isNaN(heatingSetpoint) || isNaN(coolingSetpoint) || coolingSetpoint <= heatingSetpoint;
                    $("#node-input-heatingSetpoint").toggleClass("input-error", isInvalid);
                    $("#node-input-coolingSetpoint").toggleClass("input-error", isInvalid);
                    $("#split-setpoint-warning").toggle(isInvalid);
                }

                // Validate specified setpoints
                function validateSpecifiedSetpoints() {
                    if ($algorithm.val() !== "specified") {
                        $("#specified-setpoint-warning").hide();
                        $("#node-input-coolingOn").removeClass("input-error");
                        $("#node-input-coolingOff").removeClass("input-error");
                        $("#node-input-heatingOff").removeClass("input-error");
                        $("#node-input-heatingOn").removeClass("input-error");
                        return;
                    }
                    const coolingOn = parseFloat($("#node-input-coolingOn").typedInput("value"));
                    const coolingOff = parseFloat($("#node-input-coolingOff").typedInput("value"));
                    const heatingOff = parseFloat($("#node-input-heatingOff").typedInput("value"));
                    const heatingOn = parseFloat($("#node-input-heatingOn").typedInput("value"));
                    const isInvalid = isNaN(coolingOn) || isNaN(coolingOff) || isNaN(heatingOff) || isNaN(heatingOn) ||
                                      coolingOn < coolingOff || coolingOff < heatingOff || heatingOff < heatingOn;
                    $("#node-input-coolingOn").toggleClass("input-error", isInvalid);
                    $("#node-input-coolingOff").toggleClass("input-error", isInvalid);
                    $("#node-input-heatingOff").toggleClass("input-error", isInvalid);
                    $("#node-input-heatingOn").toggleClass("input-error", isInvalid);
                    $("#specified-setpoint-warning").toggle(isInvalid);
                }

                $("#node-input-heatingSetpoint").typedInput("on", "change", validateSplitSetpoints);
                $("#node-input-coolingSetpoint").typedInput("on", "change", validateSplitSetpoints);
                $("#node-input-coolingOn").typedInput("on", "change", validateSpecifiedSetpoints);
                $("#node-input-coolingOff").typedInput("on", "change", validateSpecifiedSetpoints);
                $("#node-input-heatingOff").typedInput("on", "change", validateSpecifiedSetpoints);
                $("#node-input-heatingOn").typedInput("on", "change", validateSpecifiedSetpoints);

                // Fetch runtime values or use configured values for effective setpoints
                $.getJSON(`/tstat-block-runtime/${node.id}`, function(data) {
                    const runtime = data || {};
                    const changes = [];

                    const algorithm = runtime.algorithm || node.algorithm;
                    const diff = runtime.diff !== undefined ? runtime.diff : Number(node.diff);
                    const anticipator = runtime.anticipator !== undefined ? runtime.anticipator : Number(node.anticipator);

                    if (algorithm === "single") {
                        const setpoint = runtime.setpoint !== undefined ? parseFloat(runtime.setpoint) : Number(node.setpoint);
                        const heatingOn = setpoint - diff / 2;
                        const heatingOff = heatingOn + anticipator;
                        const coolingOn = setpoint + diff / 2;
                        const coolingOff = coolingOn - anticipator;
                        changes.push(`effectiveHeatingOn: ${heatingOn.toFixed(1)}`);
                        changes.push(`effectiveHeatingOff: ${heatingOff.toFixed(1)}`);
                        changes.push(`effectiveCoolingOn: ${coolingOn.toFixed(1)}`);
                        changes.push(`effectiveCoolingOff: ${coolingOff.toFixed(1)}`);
                    } else if (algorithm === "split") {
                        const heatingSetpoint = runtime.heatingSetpoint !== undefined ? parseFloat(runtime.heatingSetpoint) : Number(node.heatingSetpoint);
                        const coolingSetpoint = runtime.coolingSetpoint !== undefined ? parseFloat(runtime.coolingSetpoint) : Number(node.coolingSetpoint);
                        const heatingOn = heatingSetpoint - diff / 2;
                        const heatingOff = heatingSetpoint + anticipator;
                        const coolingOn = coolingSetpoint + diff / 2;
                        const coolingOff = coolingSetpoint - anticipator;
                        changes.push(`effectiveHeatingOn: ${heatingOn.toFixed(1)}`);
                        changes.push(`effectiveHeatingOff: ${heatingOff.toFixed(1)}`);
                        changes.push(`effectiveCoolingOn: ${coolingOn.toFixed(1)}`);
                        changes.push(`effectiveCoolingOff: ${coolingOff.toFixed(1)}`);
                    } else {
                        const coolingOn = runtime.coolingOn !== undefined ? parseFloat(runtime.coolingOn) : Number(node.coolingOn);
                        const coolingOff = runtime.coolingOff !== undefined ? parseFloat(runtime.coolingOff) : Number(node.coolingOff);
                        const heatingOff = runtime.heatingOff !== undefined ? parseFloat(runtime.heatingOff) : Number(node.heatingOff);
                        const heatingOn = runtime.heatingOn !== undefined ? parseFloat(runtime.heatingOn) : Number(node.heatingOn);
                        changes.push(`effectiveHeatingOn: ${heatingOn.toFixed(1)}`);
                        changes.push(`effectiveHeatingOff: ${(heatingOff + anticipator).toFixed(1)}`);
                        changes.push(`effectiveCoolingOn: ${coolingOn.toFixed(1)}`);
                        changes.push(`effectiveCoolingOff: ${(coolingOff - anticipator).toFixed(1)}`);
                    }

                    const displayText = `Effective Setpoints:\n${changes.join("\n")}`;
                    $("#node-runtime-changes").text(displayText);
                }).fail(function() {
                    const changes = [];

                    const algorithm = node.algorithm;
                    const diff = Number(node.diff);
                    const anticipator = Number(node.anticipator);

                    if (algorithm === "single") {
                        const setpoint = Number(node.setpoint);
                        const heatingOn = setpoint - diff / 2;
                        const heatingOff = heatingOn + anticipator;
                        const coolingOn = setpoint + diff / 2;
                        const coolingOff = coolingOn - anticipator;
                        changes.push(`effectiveHeatingOn: ${heatingOn.toFixed(1)}`);
                        changes.push(`effectiveHeatingOff: ${heatingOff.toFixed(1)}`);
                        changes.push(`effectiveCoolingOn: ${coolingOn.toFixed(1)}`);
                        changes.push(`effectiveCoolingOff: ${coolingOff.toFixed(1)}`);
                    } else if (algorithm === "split") {
                        const heatingSetpoint = Number(node.heatingSetpoint);
                        const coolingSetpoint = Number(node.coolingSetpoint);
                        const heatingOn = heatingSetpoint - diff / 2;
                        const heatingOff = heatingSetpoint + anticipator;
                        const coolingOn = coolingSetpoint + diff / 2;
                        const coolingOff = coolingSetpoint - anticipator;
                        changes.push(`effectiveHeatingOn: ${heatingOn.toFixed(1)}`);
                        changes.push(`effectiveHeatingOff: ${heatingOff.toFixed(1)}`);
                        changes.push(`effectiveCoolingOn: ${coolingOn.toFixed(1)}`);
                        changes.push(`effectiveCoolingOff: ${coolingOff.toFixed(1)}`);
                    } else {
                        const coolingOn = Number(node.coolingOn);
                        const coolingOff = Number(node.coolingOff);
                        const heatingOff = Number(node.heatingOff);
                        const heatingOn = Number(node.heatingOn);
                        changes.push(`effectiveHeatingOn: ${heatingOn.toFixed(1)}`);
                        changes.push(`effectiveHeatingOff: ${(heatingOff + anticipator).toFixed(1)}`);
                        changes.push(`effectiveCoolingOn: ${coolingOn.toFixed(1)}`);
                        changes.push(`effectiveCoolingOff: ${(coolingOff - anticipator).toFixed(1)}`);
                    }

                    const displayText = `Effective Setpoints:\n${changes.join("\n")}`;
                    $("#node-runtime-changes").text(displayText);
                });
            } catch (err) {
                console.error("Error in tstat-block oneditprepare:", err);
            }
        },
        oneditsave: function() {
            $("#node-input-setpointType").val($("#node-input-setpoint").typedInput("type"));
            $("#node-input-heatingSetpointType").val($("#node-input-heatingSetpoint").typedInput("type"));
            $("#node-input-coolingSetpointType").val($("#node-input-coolingSetpoint").typedInput("type"));
            $("#node-input-coolingOnType").val($("#node-input-coolingOn").typedInput("type"));
            $("#node-input-coolingOffType").val($("#node-input-coolingOff").typedInput("type"));
            $("#node-input-heatingOffType").val($("#node-input-heatingOff").typedInput("type"));
            $("#node-input-heatingOnType").val($("#node-input-heatingOn").typedInput("type"));
            $("#node-input-setpoint").val($("#node-input-setpoint").typedInput("value"));
            $("#node-input-heatingSetpoint").val($("#node-input-heatingSetpoint").typedInput("value"));
            $("#node-input-coolingSetpoint").val($("#node-input-coolingSetpoint").typedInput("value"));
            $("#node-input-coolingOn").val($("#node-input-coolingOn").typedInput("value"));
            $("#node-input-coolingOff").val($("#node-input-coolingOff").typedInput("value"));
            $("#node-input-heatingOff").val($("#node-input-heatingOff").typedInput("value"));
            $("#node-input-heatingOn").val($("#node-input-heatingOn").typedInput("value"));
        },
        oneditvalidate: function() {
            const anticipator = parseFloat($("#node-input-anticipator").val());
            const diff = parseFloat($("#node-input-diff").val());
            if (isNaN(anticipator) || anticipator < 0) {
                $("#node-input-anticipator").addClass("input-error");
                return false;
            }
            if ($("#node-input-algorithm").val() === "single") {
                if (isNaN(diff) || diff <= 0) {
                    $("#node-input-diff").addClass("input-error");
                    return false;
                }
            }
            if ($("#node-input-algorithm").val() === "split") {
                const heatingSetpoint = parseFloat($("#node-input-heatingSetpoint").typedInput("value"));
                const coolingSetpoint = parseFloat($("#node-input-coolingSetpoint").typedInput("value"));
                if (isNaN(heatingSetpoint) || isNaN(coolingSetpoint) || coolingSetpoint <= heatingSetpoint) {
                    $("#node-input-heatingSetpoint").addClass("input-error");
                    $("#node-input-coolingSetpoint").addClass("input-error");
                    $("#split-setpoint-warning").show();
                    return false;
                }
            }
            if ($("#node-input-algorithm").val() === "specified") {
                const coolingOn = parseFloat($("#node-input-coolingOn").typedInput("value"));
                const coolingOff = parseFloat($("#node-input-coolingOff").typedInput("value"));
                const heatingOff = parseFloat($("#node-input-heatingOff").typedInput("value"));
                const heatingOn = parseFloat($("#node-input-heatingOn").typedInput("value"));
                if (isNaN(coolingOn) || isNaN(coolingOff) || isNaN(heatingOff) || isNaN(heatingOn) ||
                    coolingOn < coolingOff || coolingOff < heatingOff || heatingOff < heatingOn) {
                    $("#node-input-coolingOn").addClass("input-error");
                    $("#node-input-coolingOff").addClass("input-error");
                    $("#node-input-heatingOff").addClass("input-error");
                    $("#node-input-heatingOn").addClass("input-error");
                    $("#specified-setpoint-warning").show();
                    return false;
                }
            }
            return true;
        }
    });
</script>

<script type="text/markdown" data-help-name="tstat-block">
Thermostat controller for heating/cooling with single, split, or specified setpoint operation, hysteresis, and anticipation to prevent overshoot.

### Inputs
: context (string) : Configures node (`"algorithm"`, `"setpoint"`, `"heatingSetpoint"`, `"coolingSetpoint"`, `"coolingOn"`, `"coolingOff"`, `"heatingOff"`, `"heatingOn"`, `"diff"`, `"anticipator"`, `"isHeating"`, `"status"`).
: payload (number | boolean | string) : Number for temperature or config values, boolean for `isHeating`, string for `algorithm` (`"single"`, `"split"`, `"specified"`).

### Outputs
: isHeating (boolean) : `true` for heating mode, `false` for cooling mode. `msg.context = "isHeating"` is attached.
: above (boolean) : `true` if input exceeds cooling on threshold (single: `setpoint + diff/2`, split: `coolingSetpoint + diff/2`, specified: `coolingOn`).
: below (boolean) : `true` if input is below heating on threshold (single: `setpoint - diff/2`, split: `heatingSetpoint - diff/2`, specified: `heatingOn`).

### Algorithms
- **Single Setpoint**:
  - Uses `setpoint`, `diff`, and `anticipator`.
  - Sets `above` if `input > setpoint + diff/2`, clears when `input < setpoint + diff/2 - anticipator`.
  - Sets `below` if `input < setpoint - diff/2`, clears when `input > setpoint - diff/2 + anticipator`.

- **Split Setpoint**:
  - Uses `heatingSetpoint`, `coolingSetpoint`, and `anticipator`.
  - For `isHeating = true`:
    - Sets `below` if `input < heatingSetpoint`, clears when `input > heatingSetpoint + anticipator`.
    - `above` is `false`.
  - For `isHeating = false`:
    - Sets `above` if `input > coolingSetpoint`, clears when `input < coolingSetpoint - anticipator`.
    - `below` is `false`.
  - Ensures `heatingSetpoint < coolingSetpoint`.

- **Specified Setpoint**:
  - Uses `coolingOn`, `coolingOff`, `heatingOff`, `heatingOn`, and `anticipator`.
  - For `isHeating = false`:
    - Sets `above` if `input > coolingOn`, clears when `input < coolingOff - anticipator`.
    - `below` is `false`.
  - For `isHeating = true`:
    - Sets `below` if `input < heatingOn`, clears when `input > heatingOff + anticipator`.
    - `above` is `false`.
  - Validates `coolingOn >= coolingOff >= heatingOff >= heatingOn`.

### Details
Compares a numeric temperature input (`msg.payload`) against setpoints to control heating or cooling. The `differential` (`diff`) applies only to the `single` setpoint algorithm, providing hysteresis. The `anticipator` stops commands early to prevent overshoot due to thermal inertia. The `isHeating` flag (typically from a changeover node) sets output 1 and selects the active setpoint(s). Configurable via editor or `msg.context` (e.g., `{ context: "coolingOn", payload: 75 }`). Effective setpoints (`effectiveHeatingOn`, `effectiveHeatingOff`, `effectiveCoolingOn`, `effectiveCoolingOff`) are always displayed in "Effective Setpoints" for both new and active nodes, showing the calculated on/off thresholds. Query runtime state with `msg.context = "status"`.

### Error Handling
- Missing `msg.payload`: No output, red status (`missing payload`, `missing input`).
- Invalid `msg.payload` (non-numeric for temperature/setpoints, non-boolean for `isHeating`, invalid string for `algorithm`): No output, red status (e.g., `invalid setpoint`, `invalid isHeating`).
- Invalid config (e.g., `diff <= 0` in single mode, `anticipator < 0`, `coolingOn < coolingOff`): Sets defaults, red status (e.g., `invalid diff, using 2`, `invalid anticipator, using 0.5`).
- Invalid setpoints (e.g., `heatingSetpoint >= coolingSetpoint`, `coolingOff < heatingOff`): No output, red status (e.g., `invalid coolingOff`).
- Inappropriate `msg.context` (e.g., `setpoint` in split/specified): No output, red status (e.g., `setpoint not used in this algorithm`).
- Unknown `msg.context`: No output, yellow status (`unknown context`).
- Invalid message: No output, red status (`invalid message`).

### Status
- Green (dot): Configuration updates (e.g., `setpoint: 70.0`, `anticipator: 0.5`, `isHeating: true`).
- Blue (dot): Outputs when state changes (e.g., `in: 65.00, out: heating, above: false, below: true`).
- Blue (ring): Outputs when state unchanged (e.g., `in: 66.00, out: heating, above: false, below: true`).
- Red (ring): Errors (e.g., `missing input`, `invalid coolingOff`, `invalid diff, using 2`).
- Yellow (ring): Warnings (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>